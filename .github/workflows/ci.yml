name: CI - Quality Gate (Semana 5)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Configurar entorno
        run: |
          echo "=== Versiones ==="
          uname -a
          make --version 2>/dev/null || true
          docker --version
          docker compose version 2>/dev/null || docker-compose --version 2>/dev/null || true
          curl --version | head -1
          bash --version | head -1

      - name: Clonar y levantar SUT (Restful Booker)
        run: |
          set -e
          git clone --depth 1 https://github.com/mwinteringham/restful-booker.git /tmp/restful-booker
          cd /tmp/restful-booker
          docker compose build 2>/dev/null || docker-compose build
          docker compose up -d 2>/dev/null || docker-compose up -d
          echo "SUT iniciado en http://localhost:3001"

      - name: Esperar SUT listo
        run: |
          set -e
          SUT_URL="${SUT_BASE_URL:-http://localhost:3001}"
          SUT_OK=0
          for i in $(seq 1 30); do
            if curl -sS -f -m 5 "${SUT_URL}/ping" >/dev/null 2>&1 || curl -sS -f -m 5 "${SUT_URL}/booking" >/dev/null 2>&1; then
              echo "SUT respondiendo en intento $i"
              SUT_OK=1
              break
            fi
            echo "Esperando SUT... intento $i/30"
            sleep 2
          done
          if [ "$SUT_OK" = "0" ]; then echo "SUT no respondió"; exit 1; fi
          echo "Esperando 10s para que MongoDB esté listo..."
          sleep 10

      - name: Warmup SUT (crear bookings)
        run: |
          set -e
          SUT_URL="${SUT_BASE_URL:-http://localhost:3001}"
          for i in $(seq 1 20); do
            RES=$(curl -sS -w "\n%{http_code}" -X POST "${SUT_URL}/booking" \
              -H "Content-Type: application/json" \
              -d '{"firstname":"CI","lastname":"Warmup","totalprice":100,"depositpaid":true,"bookingdates":{"checkin":"2017-12-31","checkout":"2018-12-31"}}' 2>/dev/null || echo -e "\n000")
            CODE=$(echo "$RES" | tail -n1)
            if [ "$CODE" = "200" ] || [ "$CODE" = "201" ]; then
              echo "Warmup OK: POST /booking retornó $CODE"
              exit 0
            fi
            echo "Warmup intento $i/20: HTTP $CODE"
            sleep 2
          done
          echo "WARN: POST /booking no respondió 200/201; el gate puede fallar (continuando)"

      - name: Ejecutar Quality Gate
        env:
          SKIP_SUT_START: "1"
          SUT_HOST: localhost
          SUT_PORT: "3001"
          BASE_URL: http://localhost:3001
        run: |
          set -e
          make perm 2>/dev/null || chmod +x ci/run_quality_gates.sh scripts/*.sh setup/*.sh
          make quality-gate

      - name: Subir evidencia como artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidencia-week5
          path: evidence/week5/
          if-no-files-found: warn

      - name: Limpiar SUT
        if: always()
        run: |
          set +e
          cd /tmp/restful-booker 2>/dev/null && (docker compose down 2>/dev/null || docker-compose down 2>/dev/null) || true
          docker ps -a -q --filter "name=restful" | xargs -r docker rm -f 2>/dev/null || true
